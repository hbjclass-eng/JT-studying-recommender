<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>쫀통 공부법 진단</title>
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,맑은 고딕,sans-serif;max-width:980px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 6px}
    .muted{color:#667085;font-size:12px}
    .box{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:12px 0;background:#fff}
    .q{border:1px solid #eef0f3;border-radius:10px;padding:10px;margin:8px 0;background:#fafbfc}
    .q h3{margin:0 0 6px;font-size:15px}
    .result{border:1px dashed #d0d5dd;border-radius:10px;padding:12px;margin-top:10px;display:none}
    button{padding:10px 14px;border:1px solid #d0d5dd;border-radius:10px;background:#fff;cursor:pointer}
    .pill{display:inline-block;background:#f2f4f7;border:1px solid #e4e7ec;border-radius:999px;padding:2px 10px;font-size:12px;margin-left:6px}
    .err{color:#b42318}
  </style>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>쫀통 진단</h1>
  <div class="muted">CSV: <code>data/questions.csv</code> · <code>data/types.csv</code></div>

  <div id="status" class="box muted">CSV 불러오는 중…</div>

  <div id="quiz" class="box" style="display:none">
    <div><b>문항</b> <span id="meta" class="pill">-</span></div>
    <div id="list"></div>
    <div style="margin-top:10px">
      <button id="btnReset">초기화</button>
      <button id="btnSubmit">결과 보기</button>
    </div>
    <div id="result" class="result"></div>
  </div>

<script>
// ----- Helpers (아이스크림 파일 패턴: Papa.parse + rows 배열 사용) -----
function rowsToObjects(rows){
  if(!rows || rows.length===0) return [];
  const header = rows[0].map(h => String(h||'').replace(/^\\uFEFF/,''));
  const out = [];
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(!r || r.length===0) continue;
    const o = {};
    for(let j=0;j<header.length;j++){ o[header[j]] = r[j]!==undefined ? r[j] : ''; }
    out.push(o);
  }
  return out;
}
function byNum(v, d=0){ const n=Number(v); return Number.isFinite(n)?n:d; }
function truth(v){ return String(v).trim()==='1' || /^true$/i.test(String(v)); }
function esc(s){ return String(s).replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#039;' }[m])); }

const DB={questions:[], axes:{}, map:[]};

function render(){
  const list=document.getElementById('list'); list.innerHTML='';
  const M = DB.questions.filter(q=>q.axis==='method' && q.active).sort((a,b)=>a.order-b.order);
  const A = DB.questions.filter(q=>q.axis==='attitude' && q.active).sort((a,b)=>a.order-b.order);
  const blocks=[['[학습 방법]',M],['[학습 태도]',A]];
  document.getElementById('meta').textContent = `문항 ${M.length + A.length}개 · 1~4점`;

  for(const [title, arr] of blocks){
    const h=document.createElement('div'); h.className='muted'; h.textContent=title; list.appendChild(h);
    for(const q of arr){
      const wrap=document.createElement('div'); wrap.className='q'; wrap.dataset.axis=q.axis;
      wrap.innerHTML = `<h3>${q.order}. ${esc(q.question)}</h3>`;
      const sel=document.createElement('select'); sel.innerHTML='<option value="">점수 선택</option>';
      for(let s=q.min_score; s<=q.max_score; s++){ sel.innerHTML += `<option value="${s}">${s}점</option>`; }
      sel.dataset.min=q.min_score; sel.dataset.max=q.max_score; sel.dataset.rev=q.reverse?1:0;
      wrap.appendChild(sel); list.appendChild(wrap);
    }
  }
  document.getElementById('quiz').style.display='block';
}

function compute(){
  const mCfg=DB.axes['method'], aCfg=DB.axes['attitude'];
  if(!mCfg||!aCfg) return {error:'축 설정이 없습니다.'};
  const selects = Array.from(document.querySelectorAll('#list select'));
  let mSum=0,aSum=0,miss=0;
  for(const s of selects){
    const v = s.value===''?null:Number(s.value);
    if(v==null){miss++; continue;}
    const min=Number(s.dataset.min)||1, max=Number(s.dataset.max)||4, rev=(s.dataset.rev==='1');
    const val = rev? (min+max-v): v;
    const axis = s.parentElement.dataset.axis;
    if(axis==='method') mSum+=val; else aSum+=val;
  }
  if(miss>0) return {error:`미응답 ${miss}개 있음`};
  const hi=(cfg,sum)=>{ switch(cfg.op_high){case '>=':return sum>=cfg.threshold;case '>':return sum>cfg.threshold;case '<=':return sum<=cfg.threshold;case '<':return sum<cfg.threshold;case '==':return sum==cfg.threshold;default:return sum>=cfg.threshold;} };
  const mLabel = hi(mCfg,mSum)?mCfg.label_high:mCfg.label_low;
  const aLabel = hi(aCfg,aSum)?aCfg.label_high:aCfg.label_low;
  const found = DB.map.find(t=>String(t.method_label)===String(mLabel) && String(t.attitude_label)===String(aLabel));
  if(!found) return {error:'유형 매핑을 찾을 수 없습니다.'};
  return {mSum,aSum,mLabel,aLabel,type:found};
}

function show(res){
  const box=document.getElementById('result'); box.style.display='block';
  if(res.error){ box.innerHTML = `<div class="err"><b>오류:</b> ${esc(res.error)}</div>`; return; }
  const t=res.type;
  box.innerHTML = `<div><b>결과:</b> ${esc(t.type_name)} <span class="pill">${esc(t.type_code)}</span></div>
    <div class="muted">합계 — 방법 ${res.mSum} / 태도 ${res.aSum}</div>
    <div style="margin-top:6px">${esc(t.description)}</div>
    <div class="muted" style="margin-top:6px">판정: [방법] ${esc(res.mLabel)} · [태도] ${esc(res.aLabel)}</div>`;
}

// ----- Load CSV exactly like the ice-cream page (Papa.parse with rows, no header option) -----
async function loadCSV_likeIceCream(){
  const status=document.getElementById('status');
  try{
    const [rq, rt] = await Promise.all([
      fetch('data/questions.csv?v='+Date.now()),
      fetch('data/types.csv?v='+Date.now())
    ]);
    if(!rq.ok || !rt.ok){
      status.innerHTML = `<span class="err">로드 실패</span> — ${!rq.ok?`questions: ${rq.status} `:''}${!rt.ok?`types: ${rt.status} `:''}`;
      return;
    }
    const [tq, tt] = await Promise.all([rq.text(), rt.text()]);
    const rowsQ = Papa.parse(tq, {skipEmptyLines:true}).data;
    const rowsT = Papa.parse(tt, {skipEmptyLines:true}).data;
    const Q = rowsToObjects(rowsQ);
    const T = rowsToObjects(rowsT);

    // map into DB the same way as before
    DB.questions = Q.map(r=>({
      qid:r.qid, axis:r.axis, order:byNum(r.order,0),
      question:r.question, min_score:byNum(r.min_score,1), max_score:byNum(r.max_score,4),
      weight:byNum(r.weight,1), reverse:truth(r.reverse), active:truth(r.active)
    }));
    DB.axes = {};
    T.filter(r=>r.record_type==='axis').forEach(r=>{
      DB.axes[r.axis] = { threshold: byNum(r.threshold,13), op_high:(r.op_high||'>=').trim(), label_high:r.label_high, label_low:r.label_low };
    });
    DB.map = T.filter(r=>r.record_type==='type').map(r=>({
      method_label:r.method_label, attitude_label:r.attitude_label, type_code:r.type_code, type_name:r.type_name, description:r.description
    }));

    status.textContent = '로드 완료';
    render();
  }catch(e){
    status.innerHTML = `<span class="err">예외 발생</span> — ${esc(e.message)}`;
  }
}

document.getElementById('btnReset').addEventListener('click', ()=>{
  document.querySelectorAll('#list select').forEach(s=>s.value='');
  const box=document.getElementById('result'); box.style.display='none'; box.innerHTML='';
});
document.getElementById('btnSubmit').addEventListener('click', ()=> show(compute()));

loadCSV_likeIceCream();
</script>
</body>
</html>
